<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How It Works - birdbird</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Merriweather:wght@400;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="config.local.js" onerror="this.remove()"></script>
    <script src="config.js"></script>
    <script src="config-loader.js"></script>
    <style>
        /* Method Page - Process Flow Diagram */

        /* Toggle Switch */
        .mode-toggle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-label {
            color: var(--text-secondary);
            font-family: 'Lato', sans-serif;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
        }

        .mode-label.active {
            color: var(--forest-deep);
            font-weight: 700;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 28px;
            background: var(--parchment-dark);
            border: 2px solid var(--forest-mid);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--forest-mid);
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch[aria-checked="true"] .toggle-slider {
            transform: translateX(32px);
        }

        /* Hidden checkbox for accessibility */
        .toggle-checkbox {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-checkbox:focus + .toggle-switch {
            outline: 2px solid var(--forest-deep);
            outline-offset: 4px;
        }

        /* Pipeline Toggle (inline after arrow) */
        .pipeline-toggle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin: 20px 0;
        }

        .pipeline-label {
            color: var(--text-secondary);
            font-family: 'Lato', sans-serif;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
        }

        .pipeline-label.active {
            color: var(--forest-deep);
            font-weight: 700;
        }

        /* Pipeline visibility */
        .video-pipeline,
        .audio-pipeline {
            display: none;
        }

        body.video-mode .video-pipeline {
            display: block;
        }

        body.audio-mode .audio-pipeline {
            display: block;
        }

        /* Pipeline Flow */
        .pipeline {
            max-width: 800px;
            margin: 0 auto;
        }

        .pipeline-step {
            margin-bottom: 0;
        }

        /* Process Box */
        .process-box {
            background: var(--cream-white);
            border: 2px solid var(--parchment-dark);
            border-radius: 4px;
            padding: 15px 20px;
            box-shadow: 0 2px 4px var(--shadow-soft);
        }

        .process-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .process-icon {
            font-size: 1.5em;
        }

        .process-title {
            font-family: 'Merriweather', Georgia, serif;
            font-size: 1.1em;
            font-weight: 700;
            color: var(--forest-deep);
            margin: 0;
        }

        .process-description {
            color: var(--text-secondary);
            line-height: 1.6;
            margin: 0;
            font-size: 0.95em;
        }

        .process-description.detail {
            display: none;
        }

        body.detail-mode .process-description.summary {
            display: none;
        }

        body.detail-mode .process-description.detail {
            display: block;
        }

        /* Data Flow Boxes */
        .data-flow {
            margin-top: 12px;
        }

        .data-output {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
            border: 2px solid var(--sky-blue);
            background: #e0f2fe;
            color: var(--text-primary);
        }

        .data-icon {
            font-size: 1.1em;
        }

        .data-text.summary {
            display: inline;
        }

        .data-text.detail {
            display: none;
        }

        body.detail-mode .data-text.summary {
            display: none;
        }

        body.detail-mode .data-text.detail {
            display: inline;
        }

        /* Connection Arrow */
        .connection-arrow {
            text-align: center;
            color: var(--forest-mid);
            font-size: 2em;
            line-height: 1;
            margin: 16px 0;
            opacity: 0.6;
        }

        /* Fix subtitle contrast */
        header .subtitle {
            opacity: 1;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .mode-toggle-container {
                flex-direction: column;
                gap: 12px;
                margin-bottom: 25px;
            }

            .process-box {
                padding: 12px 16px;
            }

            .process-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .process-icon {
                font-size: 1.3em;
            }

            .process-title {
                font-size: 1em;
            }

            .data-output {
                font-size: 0.8em;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>How It Works</h1>
            <p class="subtitle">Pipeline Architecture</p>
        </header>

        <div class="content">
            <nav aria-label="Breadcrumb" class="breadcrumb">
                <a href="index.html">Home</a>
                <span class="separator">/</span>
                <span class="current">How It Works</span>
            </nav>

            <!-- Mode Toggle -->
            <div class="mode-toggle-container">
                <span class="mode-label active" id="summary-label">Summary</span>
                <label class="toggle-switch"
                       role="switch"
                       aria-checked="false"
                       aria-labelledby="summary-label detail-label"
                       tabindex="0">
                    <input type="checkbox"
                           id="mode-toggle"
                           class="toggle-checkbox"
                           aria-label="Toggle between summary and detail descriptions">
                    <span class="toggle-slider"></span>
                </label>
                <span class="mode-label" id="detail-label">Detail</span>
            </div>

            <!-- Pipeline Flow -->
            <div class="pipeline">
                <!-- Step 1: Raw Input -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">üìπ</div>
                            <h2 class="process-title">Raw Video Clips</h2>
                        </div>
                        <p class="process-description summary">
                            Motion capture camera records bird activity, producing many video clips.
                        </p>
                        <p class="process-description detail">
                            A typical batch could contain several hundred 10-second clips.  Downloading/moving from the capture device is not handled by the app.
                            The entry point for the app is a folder in YYYYMMDD format, named for the date they were taken off the device.
                            The actual clips in that folder could cover several days.  Filename timestamps could be unreliable so the folder name is the source of truth.
                            If files are named like DDHHmmss00.avi this will be used to capture the start date of the batch.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">üé¨</span>
                                <span class="data-text summary">Hundreds of 10-second clips</span>
                                <span class="data-text detail">Tested with AVI files (MJPEG 1440x1080@30fps, ~10s each)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="connection-arrow">‚¨áÔ∏è</div>

                <!-- Pipeline Toggle -->
                <div class="pipeline-toggle-container">
                    <span class="pipeline-label active" id="video-label">Video Pipeline</span>
                    <label class="toggle-switch"
                           role="switch"
                           aria-checked="false"
                           aria-labelledby="video-label audio-label"
                           tabindex="0"
                           id="pipeline-toggle-switch">
                        <input type="checkbox"
                               id="pipeline-toggle"
                               class="toggle-checkbox"
                               aria-label="Toggle between video and audio pipeline">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="pipeline-label" id="audio-label">Audio Pipeline</span>
                </div>

                <!-- VIDEO PIPELINE -->
                <section class="video-pipeline" aria-label="Video processing pipeline">

                <!-- Step 2: Filter -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">‚öôÔ∏è</div>
                            <h2 class="process-title">Discard Clips With No Birds</h2>
                        </div>
                        <p class="process-description summary">
                            Some clips might not have any birds if the motion capture was triggered by wind movement.
                            Automatically scan each video to detect bird presence. Only keep clips containing birds.
                        </p>
                        <p class="process-description detail">
                            We capture a few frames (4√ó in first second, then 1fps) and run these through YOLOv8-nano inference
                            for COCO class 14 (bird). Outputs detections.json with confidence scores, bounding box coordinates, and
                            frame timestamps. Clips without bird detections are moved to a separate directory. Typical detection rate in original testing: 20-30% of input clips.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">‚úì</span>
                                <span class="data-text summary">Smaller set of clips</span>
                                <span class="data-text detail">Filtered clips, and data file detections.json with confidence scores and timestamps per frame</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="connection-arrow">‚¨áÔ∏è</div>

                <!-- Step 3: Highlights -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">‚úÇÔ∏è</div>
                            <h2 class="process-title">Make Highlights Reel</h2>
                        </div>
                        <p class="process-description summary">
                            Trim each clip to show only the bird activity, then combine all segments into one highlights video.
                        </p>
                        <p class="process-description detail">
                            Binary search algorithm identifies optimal segment boundaries using cached detection timestamps from the filter step.
                            Each clip is trimmed to show only portions with bird activity. FFmpeg concatenates all segments using stream copy
                            (no re-encoding) for fast processing. Output: highlights.mp4 - in our tests typically 5-10 minutes duration.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">üéûÔ∏è</span>
                                <span class="data-text summary">One highlights file</span>
                                <span class="data-text detail">highlights.mp4 (H.264, variable duration)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="connection-arrow">‚¨áÔ∏è</div>

                <!-- Step 4: Species ID -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">üîç</div>
                            <h2 class="process-title">Identify Species</h2>
                        </div>
                        <p class="process-description summary">
                            Analyse the highlights to determine which bird species appear, with confidence scores and timing.
                        </p>
                        <p class="process-description detail">
                            We take frame captures from highlights.mp4 at short intervals (every 2 seconds in our testing).  This could miss birds which
                            appear very briefly, it's a trade-off with the time-consuming processing.  The BioCLIP vision-language model performs zero-shot
                            species identification on the frames.  To further speed up the matching, we pass a fixed list of species.
                            The matching requires a GPU for reasonable performance - there's an option to run on remote GPU server.  The model scores each match with &percnt; confidence.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">üìä</span>
                                <span class="data-text summary">Timeline, counts, confidence scores</span>
                                <span class="data-text detail">Output metadata in species.json includes timestamps, common/scientific names, and confidence scores.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="connection-arrow">‚¨áÔ∏è</div>

                <!-- Step 5: Best Sections -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">‚≠ê</div>
                            <h2 class="process-title">Find Best Sections</h2>
                        </div>
                        <p class="process-description summary">
                            Rank video segments by species diversity and quality to suggest the most interesting timestamps to view.
                        </p>
                        <p class="process-description detail">
                            Using the frame timeline from the previous step, for each species we identify the "best" short segment for viewing.
                            For example the "best" point in the highlights for robins is scored as the 8 consecutive frames (14 seconds) with the highest cumulative
                            confidence for robins.  Later when we select the robins button the video will seek to the start of the identified segment.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">üéØ</span>
                                <span class="data-text summary">Suggested best timestamps and count per species</span>
                                <span class="data-text detail">For each species: counts of frames where it was found, best segment timestamp.  File species.json.</span>
                            </div>
                        </div>
                    </div>
                </div>

                </section><!-- /video-pipeline -->

                <!-- AUDIO PIPELINE -->
                <section class="audio-pipeline" aria-label="Audio processing pipeline">

                <!-- Audio Step 1: Extract Audio -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">üîä</div>
                            <h2 class="process-title">Extract Audio Track</h2>
                        </div>
                        <p class="process-description summary">
                            Extract the audio from each video clip for acoustic analysis.
                        </p>
                        <p class="process-description detail">
                            FFmpeg extracts audio tracks from AVI files to temporary WAV files (16kHz mono PCM).
                            This format is required by the BirdNET analyser. Files are processed in batches and
                            temporary WAVs are cleaned up after analysis.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">üéµ</span>
                                <span class="data-text summary">Audio files for analysis</span>
                                <span class="data-text detail">Temporary WAV files (16kHz mono) extracted from each clip</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="connection-arrow">‚¨áÔ∏è</div>

                <!-- Audio Step 2: BirdNET Analysis -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">üê¶</div>
                            <h2 class="process-title">BirdNET Analysis</h2>
                        </div>
                        <p class="process-description summary">
                            Identify bird species by their songs and calls using acoustic analysis.
                        </p>
                        <p class="process-description detail">
                            BirdNET-Analyzer processes audio in 3-second segments, detecting bird vocalisations and
                            identifying species. Outputs include common and scientific names, confidence scores, and
                            timestamps. Optional location filtering (latitude/longitude) restricts results to regionally
                            appropriate species. The web viewer selects the highest-scoring clip per species.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">üìä</span>
                                <span class="data-text summary">Species detections with confidence scores</span>
                                <span class="data-text detail">songs.json with species names, confidence scores, source clips, and timestamps</span>
                            </div>
                        </div>
                    </div>
                </div>

                </section><!-- /audio-pipeline -->

                <div class="connection-arrow">‚¨áÔ∏è</div>

                <!-- Step 6: Web Viewer -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">üåê</div>
                            <h2 class="process-title">Present on Website</h2>
                        </div>
                        <p class="process-description summary">
                            Upload highlights and data to the cloud. View video with playback controls and visual/audio statistics.
                        </p>
                        <p class="process-description detail">
                            Highlights video and JSON metadata uploaded to Amazon S3 (or compatible stores, in our testing we used Cloudflare R2) object storage, organised per batch.
                            Static HTML viewer fetches content directly from S3/R2 via client-side JavaScript. The latest.json index drives the navigation controls for batch selection.
                            The viewer is deployed to Cloudflare Workers for global CDN distribution.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">üì±</span>
                                <span class="data-text summary">Interactive web app with player and stats</span>
                                <span class="data-text detail">Static HTML viewer + MP4 hosted on S3-compatible object store with latest.json index and timeline data</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            Powered by birdbird |
            <a href="credits.html">Credits</a> |
            <a href="accessibility.html">Accessibility</a>
        </footer>
    </div>

    <script>
        // Toggle between summary and detail modes
        const modeToggle = document.getElementById('mode-toggle');
        const modeToggleSwitch = modeToggle.closest('label');
        const summaryLabel = document.getElementById('summary-label');
        const detailLabel = document.getElementById('detail-label');

        function updateMode(isTechnical) {
            if (isTechnical) {
                document.body.classList.add('detail-mode');
                modeToggleSwitch.setAttribute('aria-checked', 'true');
                summaryLabel.classList.remove('active');
                detailLabel.classList.add('active');
            } else {
                document.body.classList.remove('detail-mode');
                modeToggleSwitch.setAttribute('aria-checked', 'false');
                summaryLabel.classList.add('active');
                detailLabel.classList.remove('active');
            }
        }

        // Handle checkbox change
        modeToggle.addEventListener('change', (e) => {
            updateMode(e.target.checked);
        });

        // Handle click on toggle switch
        modeToggleSwitch.addEventListener('click', () => {
            modeToggle.checked = !modeToggle.checked;
            updateMode(modeToggle.checked);
        });

        // Handle keyboard navigation (Space/Enter on toggle)
        modeToggleSwitch.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                modeToggle.checked = !modeToggle.checked;
                updateMode(modeToggle.checked);
            }
        });

        // Handle label clicks
        summaryLabel.addEventListener('click', () => {
            modeToggle.checked = false;
            updateMode(false);
        });

        detailLabel.addEventListener('click', () => {
            modeToggle.checked = true;
            updateMode(true);
        });

        // Pipeline toggle (video/audio)
        const pipelineToggle = document.getElementById('pipeline-toggle');
        const pipelineToggleSwitch = document.getElementById('pipeline-toggle-switch');
        const videoLabel = document.getElementById('video-label');
        const audioLabel = document.getElementById('audio-label');

        function updatePipeline(isAudio) {
            if (isAudio) {
                document.body.classList.remove('video-mode');
                document.body.classList.add('audio-mode');
                pipelineToggleSwitch.setAttribute('aria-checked', 'true');
                videoLabel.classList.remove('active');
                audioLabel.classList.add('active');
            } else {
                document.body.classList.remove('audio-mode');
                document.body.classList.add('video-mode');
                pipelineToggleSwitch.setAttribute('aria-checked', 'false');
                videoLabel.classList.add('active');
                audioLabel.classList.remove('active');
            }
        }

        // Handle checkbox change
        pipelineToggle.addEventListener('change', (e) => {
            updatePipeline(e.target.checked);
        });

        // Handle click on toggle switch
        pipelineToggleSwitch.addEventListener('click', () => {
            pipelineToggle.checked = !pipelineToggle.checked;
            updatePipeline(pipelineToggle.checked);
        });

        // Handle keyboard navigation
        pipelineToggleSwitch.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                pipelineToggle.checked = !pipelineToggle.checked;
                updatePipeline(pipelineToggle.checked);
            }
        });

        // Handle label clicks
        videoLabel.addEventListener('click', () => {
            pipelineToggle.checked = false;
            updatePipeline(false);
        });

        audioLabel.addEventListener('click', () => {
            pipelineToggle.checked = true;
            updatePipeline(true);
        });

        // Initialize both toggles
        updateMode(modeToggle.checked);
        updatePipeline(pipelineToggle.checked);
    </script>
</body>
</html>

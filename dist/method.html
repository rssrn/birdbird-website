<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How It Works - birdbird</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Merriweather:wght@400;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <script src="config-loader.js"></script>
    <style>
        /* Method Page - Process Flow Diagram */

        /* Toggle Switch */
        .mode-toggle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-label {
            color: var(--text-secondary);
            font-family: 'Lato', sans-serif;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
        }

        .mode-label.active {
            color: var(--forest-deep);
            font-weight: 700;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 28px;
            background: var(--parchment-dark);
            border: 2px solid var(--forest-mid);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--forest-mid);
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch[aria-checked="true"] .toggle-slider {
            transform: translateX(32px);
        }

        /* Hidden checkbox for accessibility */
        #mode-toggle {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        #mode-toggle:focus + .toggle-switch {
            outline: 2px solid var(--forest-deep);
            outline-offset: 4px;
        }

        /* Pipeline Flow */
        .pipeline {
            max-width: 800px;
            margin: 0 auto;
        }

        .pipeline-step {
            margin-bottom: 0;
        }

        /* Process Box */
        .process-box {
            background: var(--cream-white);
            border: 2px solid var(--parchment-dark);
            border-radius: 4px;
            padding: 15px 20px;
            box-shadow: 0 2px 4px var(--shadow-soft);
        }

        .process-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .process-icon {
            font-size: 1.5em;
        }

        .process-title {
            font-family: 'Merriweather', Georgia, serif;
            font-size: 1.1em;
            font-weight: 700;
            color: var(--forest-deep);
            margin: 0;
        }

        .process-description {
            color: var(--text-secondary);
            line-height: 1.6;
            margin: 0;
            font-size: 0.95em;
        }

        .process-description.detail {
            display: none;
        }

        body.detail-mode .process-description.summary {
            display: none;
        }

        body.detail-mode .process-description.detail {
            display: block;
        }

        /* Data Flow Boxes */
        .data-flow {
            margin-top: 12px;
        }

        .data-output {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
            border: 2px solid var(--sky-blue);
            background: #e0f2fe;
            color: var(--text-primary);
        }

        .data-icon {
            font-size: 1.1em;
        }

        .data-text.summary {
            display: inline;
        }

        .data-text.detail {
            display: none;
        }

        body.detail-mode .data-text.summary {
            display: none;
        }

        body.detail-mode .data-text.detail {
            display: inline;
        }

        /* Connection Arrow */
        .connection-arrow {
            text-align: center;
            color: var(--forest-mid);
            font-size: 2em;
            line-height: 1;
            margin: 16px 0;
            opacity: 0.6;
        }

        /* Fix subtitle contrast */
        header .subtitle {
            opacity: 1;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .mode-toggle-container {
                flex-direction: column;
                gap: 12px;
                margin-bottom: 25px;
            }

            .process-box {
                padding: 12px 16px;
            }

            .process-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .process-icon {
                font-size: 1.3em;
            }

            .process-title {
                font-size: 1em;
            }

            .data-output {
                font-size: 0.8em;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>How It Works</h1>
            <p class="subtitle">Pipeline Architecture</p>
        </header>

        <div class="content">
            <nav aria-label="Breadcrumb" class="breadcrumb">
                <a href="index.html">Home</a>
                <span class="separator">/</span>
                <span class="current">How It Works</span>
            </nav>

            <!-- Mode Toggle -->
            <div class="mode-toggle-container">
                <span class="mode-label active" id="summary-label">Summary</span>
                <label class="toggle-switch"
                       role="switch"
                       aria-checked="false"
                       aria-labelledby="summary-label detail-label"
                       tabindex="0">
                    <input type="checkbox"
                           id="mode-toggle"
                           aria-label="Toggle between summary and detail descriptions">
                    <div class="toggle-slider"></div>
                </label>
                <span class="mode-label" id="detail-label">Detail</span>
            </div>

            <!-- Pipeline Flow -->
            <div class="pipeline">
                <!-- Step 1: Raw Input -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">üìπ</div>
                            <h2 class="process-title">Raw Video Clips</h2>
                        </div>
                        <p class="process-description summary">
                            Motion capture camera records bird activity, creating many 10-second video clips.
                        </p>
                        <p class="process-description detail">
                            Input source: AVI format (MJPEG codec, 1440x1080, 30fps). Typical batch contains several hundred 10-second clips.
                            Filename convention: DDHHmmss00.avi encodes day and time. Date metadata extracted from parent
                            directory name (YYYYMMDD format) to handle camera clock drift scenarios.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">üé¨</span>
                                <span class="data-text summary">Example: Many 10-second clips</span>
                                <span class="data-text detail">AVI files (MJPEG 1440x1080@30fps, ~10s each)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="connection-arrow">‚¨áÔ∏è</div>

                <!-- Step 2: Filter -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">‚öôÔ∏è</div>
                            <h2 class="process-title">Check Each Clip</h2>
                        </div>
                        <p class="process-description summary">
                            Automatically scan each video to detect bird presence. Only keep clips containing birds.
                        </p>
                        <p class="process-description detail">
                            Detection pipeline: Weighted frame sampling (4√ó in first second, then 1fps) feeds YOLOv8-nano inference
                            for COCO class 14 (bird). Outputs detections.json with confidence scores, bounding box coordinates, and
                            frame timestamps. Clips without bird detections are moved to a separate directory. Typical detection rate: 20-30% of input clips.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">‚úì</span>
                                <span class="data-text summary">Fewer clips with birds detected</span>
                                <span class="data-text detail">Filtered clips + detections.json (bbox coordinates, confidence scores)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="connection-arrow">‚¨áÔ∏è</div>

                <!-- Step 3: Highlights -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">‚úÇÔ∏è</div>
                            <h2 class="process-title">Make Highlights Reel</h2>
                        </div>
                        <p class="process-description summary">
                            Trim each clip to show only the bird activity, then combine all segments into one video file.
                        </p>
                        <p class="process-description detail">
                            Binary search algorithm identifies optimal segment boundaries using cached detection timestamps from filter step.
                            Each clip is trimmed to show only portions with bird activity. FFmpeg concatenates all segments using stream copy
                            (no re-encoding) for fast processing. Output: single H.264 MP4 file, typically 5-10 minutes duration.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">üéûÔ∏è</span>
                                <span class="data-text summary">One highlights file</span>
                                <span class="data-text detail">highlights.mp4 (H.264, variable duration, segment timestamps)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="connection-arrow">‚¨áÔ∏è</div>

                <!-- Step 4: Species ID -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">üîç</div>
                            <h2 class="process-title">Identify Species</h2>
                        </div>
                        <p class="process-description summary">
                            Analyze the highlights to determine which bird species appear, with confidence scores and timing.
                        </p>
                        <p class="process-description detail">
                            BioCLIP vision-language model performs zero-shot species identification on keyframes from the highlights video.
                            Multi-modal embedding space matches visual features against bird species taxonomies. Runs on remote GPU server
                            for efficient batch processing. Output metadata includes common/scientific names, temporal bounds, and confidence scores.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">üìä</span>
                                <span class="data-text summary">Timeline, counts, confidence scores</span>
                                <span class="data-text detail">Species metadata JSON (taxonomy, temporal bounds, confidence distributions)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="connection-arrow">‚¨áÔ∏è</div>

                <!-- Step 5: Best Sections -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">‚≠ê</div>
                            <h2 class="process-title">Find Best Sections</h2>
                        </div>
                        <p class="process-description summary">
                            Rank video segments by species diversity and quality to suggest the most interesting timestamps. (Planned feature)
                        </p>
                        <p class="process-description detail">
                            Planned: Multi-criteria scoring algorithm will rank segments based on species diversity, detection confidence,
                            and temporal uniqueness. Sliding window analysis with configurable segment length to identify peak activity periods.
                            Will output ranked timestamp suggestions highlighting the best moments for each species observed.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">üéØ</span>
                                <span class="data-text summary">Suggested best timestamps per species</span>
                                <span class="data-text detail">Ranked timestamp suggestions with scoring justifications and quality metrics</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="connection-arrow">‚¨áÔ∏è</div>

                <!-- Step 6: Web Viewer -->
                <div class="pipeline-step">
                    <div class="process-box">
                        <div class="process-header">
                            <div class="process-icon">üåê</div>
                            <h2 class="process-title">Present on Website</h2>
                        </div>
                        <p class="process-description summary">
                            Upload highlights and data to the cloud. View video with playback controls and visual/audio statistics.
                        </p>
                        <p class="process-description detail">
                            Highlights video and metadata uploaded to Cloudflare R2 object storage using YYYYMMDD-NN batch versioning.
                            Static HTML viewer fetches content via client-side JavaScript. The latest.json index maintains current batch
                            information and archive links. Deployed to Cloudflare Workers for global CDN distribution.
                        </p>
                        <div class="data-flow">
                            <div class="data-output">
                                <span class="data-icon">üì±</span>
                                <span class="data-text summary">Interactive web app with player and stats</span>
                                <span class="data-text detail">Static HTML viewer + MP4 hosted on Cloudflare R2 with latest.json index</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            Powered by birdbird |
            <a href="credits.html">Credits</a> |
            <a href="accessibility.html">Accessibility</a>
            <div style="font-size: 0.85em; margin-top: 12px; opacity: 0.8;">
                Bird detection using YOLOv8 trained on
                <a href="https://cocodataset.org/">COCO dataset</a>
                (<a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>)
            </div>
        </footer>
    </div>

    <script>
        // Toggle between summary and detail modes
        const modeToggle = document.getElementById('mode-toggle');
        const toggleSwitch = document.querySelector('.toggle-switch');
        const summaryLabel = document.getElementById('summary-label');
        const detailLabel = document.getElementById('detail-label');

        function updateMode(isTechnical) {
            if (isTechnical) {
                document.body.classList.add('detail-mode');
                toggleSwitch.setAttribute('aria-checked', 'true');
                summaryLabel.classList.remove('active');
                detailLabel.classList.add('active');
            } else {
                document.body.classList.remove('detail-mode');
                toggleSwitch.setAttribute('aria-checked', 'false');
                summaryLabel.classList.add('active');
                detailLabel.classList.remove('active');
            }
        }

        // Handle checkbox change
        modeToggle.addEventListener('change', (e) => {
            updateMode(e.target.checked);
        });

        // Handle click on toggle switch
        toggleSwitch.addEventListener('click', () => {
            modeToggle.checked = !modeToggle.checked;
            updateMode(modeToggle.checked);
        });

        // Handle keyboard navigation (Space/Enter on toggle)
        toggleSwitch.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                modeToggle.checked = !modeToggle.checked;
                updateMode(modeToggle.checked);
            }
        });

        // Handle label clicks
        summaryLabel.addEventListener('click', () => {
            modeToggle.checked = false;
            updateMode(false);
        });

        detailLabel.addEventListener('click', () => {
            modeToggle.checked = true;
            updateMode(true);
        });

        // Initialize
        updateMode(modeToggle.checked);
    </script>
</body>
</html>
